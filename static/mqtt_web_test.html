<!DOCTYPE html>
<html>
    <head>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

        <script>
            var camId = 'cam1';
            var camWakeTimer = null;

            window.onload = function() {
                // Create a client instance
                client = new Paho.MQTT.Client('rabbitws.localhost', 80, "/ws", "clientId");

                // set callback handlers
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                connect()
            };

            // connect to broker
            function connect() {
                console.log('connecting...')
                client.connect({
                    onSuccess:onConnect,
                    onFailure:onConnectionLost,
                    userName:"guest",
                    password:"guest",
                    useSSL: false
                });
            }

            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                client.subscribe("pycam/captures/#");
                client.subscribe("pycam/status/#");

                // wake up cameras
                wakeUp();

                // setup camera timers
                camWakeTimer = setInterval(function () {
                    wakeUp();
                }, 2000);
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost: " + responseObject.errorMessage);

                    // kill camera timer(s)
                    window.clearInterval(camWakeTimer)
                }

                // reconnect the client
                window.setTimeout(function () {
                    connect()
                }, 4000);
            }

            // called when a message arrives
            function onMessageArrived(message) {
                if (message.destinationName.includes('pycam/status/')) {
                    document.getElementById('label').innerHTML = 'status: ' + message.payloadString.length;
                }
                else if (message.destinationName.includes('pycam/captures/')) {
                    document.getElementById('label').innerHTML = 'capture: ' + message.payloadString.length;
                    //document.getElementById('cam').src = 'data:image/png;base64,' + message.payloadString;                
                }
            }

            function captureStill() {
                message = new Paho.MQTT.Message('{"command": "capture"}');
                message.destinationName = 'pycam/control/' + camId;
                client.send(message);
            }

            function wakeUp() {
                message = new Paho.MQTT.Message('{"command": "wake_up"}');
                message.destinationName = 'pycam/control/' + camId;
                client.send(message);
            }

        </script>

    </head>

    <body>

        <div>

            <div id='label'></div>
            <img id='cam' src=''/>
            <button onclick='captureStill()'>Capture</button>

        </div>

    </body>
</html>